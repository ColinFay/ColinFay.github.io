<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.11.1 by Michael Rose
  Copyright 2013-2018 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE.txt
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>A Crazy Little Thing Called {purrr} - Part 4: mappers - Colin Fay</title>
<meta name="description" content="I won’t talk about the Queen reference anymore.I’ve been working lately on a new package called {attempt}, which is anattempt at making try catch and condition handling in R a little bitfriendlier. If you have some time to spare, I’ll be glad if you can giveme some feedbacks about it: positive, negative, PR, improvementsuggestions https://github.com/ColinFay/attempt… Feel free!This package relies a lot on {purrr} mappers (and on {rlang} but I won’tbe talking about {rlang} today… maybe in another series of posts). TodayI’m gonna talk briefly about this cool stuff in {purrr} called mappers.(Well, these mappers are forwarded to {rlang} so this is a cool stufffrom {rlang}, yet the mappers constructor as_mapper is a {purrr}function).What on earth are mappersYou’ve been using mappers a lot if, like me, you’ve been using {purrr} alot. These are the one sided formulas which are created as such :library(purrr)map_dbl(1:3, ~ .x * 10)## [1] 10 20 30# or map_dbl(1:3, ~ . * 10)## [1] 10 20 30# or map2_dbl(1:3, 3:5, ~ .x + .y)## [1] 4 6 8Here, you’re creating a lambda function on the fly: the first and secondmultiplying each element by 10, and the third adding each x and ytogether.What’s happening behind?The first thing that map (and other map_*) do is turning a the ~ .x\* 10 into a mapper with as_mapper.map## function(.x, .f, ...) {##   .f &lt;- as_mapper(.f, ...)##   .Call(map_impl, environment(), &quot;.x&quot;, &quot;.f&quot;, &quot;list&quot;)## }## &lt;environment: namespace:purrr&gt;In the background, mappers are created with {rlang} as_function: so,as you could have guessed, this turns formulas into functions.addition &lt;- as_mapper(~ .x + .y)addition## function (..., .x = ..1, .y = ..2, . = ..1) ## .x + .yAs you can see, the function is created with the .x matching the firstargument, the .y matching the second, and the . alone matching thefirst. It’s that simple, you now have a good old R function:addition(1,3)## [1] 4How is that useful?Don’t repeat yourselfThis first comes handy when you have a lot of mapping to do:map2_int(1:3, 4:6, addition)## [1] 5 7 9map2_int(1:10, 21:30, addition)##  [1] 22 24 26 28 30 32 34 36 38 40map2_int(2:3, 4:5, addition)## [1] 6 8Flexible mappersMappers are what allow {purrr} flexibility with mapping, as it alows youto use a defaut R functions inside map:as_mapper(is.numeric)## function (x) ## is.numeric(x = x)## &lt;environment: base&gt;or characters and numbers that creates calls to pluck:as_mapper(1)## function (x, ...) ## pluck(x, list(1), .default = NULL)## &lt;environment: 0x7fcae3543788&gt;as_mapper(&quot;this&quot;)## function (x, ...) ## pluck(x, list(&quot;this&quot;), .default = NULL)## &lt;environment: 0x7fcae3280190&gt;or even another lambda function :as_mapper(function(x, y) {x+y} )## function(x, y) {x+y}mappers with more than two argumentsSo, here’s the trick if you want to create mappers with more than twoarguments: use ..1, ..2, ..3, etc. Here’s an example with pmap.l &lt;- list(rnorm(10),          rnorm(100),           rnorm(1000))pmap_dbl(list(l, 20, TRUE), ~ mean(..1, ..2, ..3)) ## [1] 0.48879956 0.15248405 0.01861908Using mapper inside {attempt}try_catchThese are also what allows {attempt} to be flexible when buildingtrycatch calls and condition handlers.As you may know, tryCatch takes four arguments :  The expression to evaluate (mandatory)  A function to be run on error  A function to be run on warning  A function to be run on exitSo if you’ve followed along, you now know that I can use mappers here asarguments of a tryCatch call. This is exactly what try_catch, from{attempt}, does.Here’s a shorten example (and slightly different from the one in{attempt} as try_that is built with {rlang} lang) :try_catch &lt;- function(expr, .e) {  tryCatch( expr,    error = as_mapper(.e)  )}try_catch(log(&quot;a&quot;), .e = ~ paste(&quot;There was an error:&quot;, .x))## [1] &quot;There was an error: Error in log(\&quot;a\&quot;): argument non numérique pour une fonction mathématique\n&quot;stop_ifAs package developers, we need to keep in mind that everything ispossible when it comes to functions being used in the wild (charactersin place of number is just an example).So the first lines of a function are usually used to verify the inputs.Like :pimped_sum &lt;- function(x, y){  if (! is.numeric(x) | ! is.numeric(y)) {    stop(&quot;x and y must be numeric&quot;)  }  x + y}pimped_sum(&quot;1&quot;, 2)## Error in pimped_sum(&quot;1&quot;, 2): x and y must be numericBut that’s a lot of duplicated code, a lot of if if there are lot ofchecks to do, and not that much functions stating clearly what they do.So here comes {attempt}:library(attempt)## ## Attaching package: &#39;attempt&#39;## The following object is masked _by_ &#39;.GlobalEnv&#39;:## ##     try_catchpimped_sum &lt;- function(x, y){  stop_if_any( c(x, y),                ~ ! is.numeric(.x),                msg = &quot;your args should be numeric&quot;)  x + y}pimped_sum(&quot;1&quot;, 2)## Error: your args should be numericYou can have a look at what {attempt} does on the GitHubrepo.# Simpler examplesmall_by_ten &lt;- function(x){  stop_if( x,            ~ .x &gt; 10,            msg = &quot;x should be less than ten&quot; )  x * 10}small_by_ten(11)## Error: x should be less than tenSo here, you can see that we are using a formula inside stop_if. Howdoes if work ? The second argument is turned into a mapper, and thenused to test x. Here’s a simplified version of this function:stop_if &lt;- function(.x, .p){  .p &lt;- as_mapper(.p)  if ( .p(.x) )      stop(&quot;Error!&quot;)}stop_if(10, ~ .x &lt; 11)## Error in stop_if(10, ~.x &lt; 11): Error!The flexibily of the mapper system allows you to pass base and classicalfunction, because as we’ve seen, they are all turned to the samefunction template :stop_if(10, is.numeric)## Error in stop_if(10, is.numeric): Error!stop_if(10, function(x) sqrt(x) &lt; 100)## Error in stop_if(10, function(x) sqrt(x) &lt; 100): Error!Aaaaaand that’s it for today :)">



<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Colin Fay">
<meta property="og:title" content="A Crazy Little Thing Called {purrr} - Part 4: mappers">
<meta property="og:url" content="http://localhost:4000/purrr-mappers/">


  <meta property="og:description" content="I won’t talk about the Queen reference anymore.I’ve been working lately on a new package called {attempt}, which is anattempt at making try catch and condition handling in R a little bitfriendlier. If you have some time to spare, I’ll be glad if you can giveme some feedbacks about it: positive, negative, PR, improvementsuggestions https://github.com/ColinFay/attempt… Feel free!This package relies a lot on {purrr} mappers (and on {rlang} but I won’tbe talking about {rlang} today… maybe in another series of posts). TodayI’m gonna talk briefly about this cool stuff in {purrr} called mappers.(Well, these mappers are forwarded to {rlang} so this is a cool stufffrom {rlang}, yet the mappers constructor as_mapper is a {purrr}function).What on earth are mappersYou’ve been using mappers a lot if, like me, you’ve been using {purrr} alot. These are the one sided formulas which are created as such :library(purrr)map_dbl(1:3, ~ .x * 10)## [1] 10 20 30# or map_dbl(1:3, ~ . * 10)## [1] 10 20 30# or map2_dbl(1:3, 3:5, ~ .x + .y)## [1] 4 6 8Here, you’re creating a lambda function on the fly: the first and secondmultiplying each element by 10, and the third adding each x and ytogether.What’s happening behind?The first thing that map (and other map_*) do is turning a the ~ .x\* 10 into a mapper with as_mapper.map## function(.x, .f, ...) {##   .f &lt;- as_mapper(.f, ...)##   .Call(map_impl, environment(), &quot;.x&quot;, &quot;.f&quot;, &quot;list&quot;)## }## &lt;environment: namespace:purrr&gt;In the background, mappers are created with {rlang} as_function: so,as you could have guessed, this turns formulas into functions.addition &lt;- as_mapper(~ .x + .y)addition## function (..., .x = ..1, .y = ..2, . = ..1) ## .x + .yAs you can see, the function is created with the .x matching the firstargument, the .y matching the second, and the . alone matching thefirst. It’s that simple, you now have a good old R function:addition(1,3)## [1] 4How is that useful?Don’t repeat yourselfThis first comes handy when you have a lot of mapping to do:map2_int(1:3, 4:6, addition)## [1] 5 7 9map2_int(1:10, 21:30, addition)##  [1] 22 24 26 28 30 32 34 36 38 40map2_int(2:3, 4:5, addition)## [1] 6 8Flexible mappersMappers are what allow {purrr} flexibility with mapping, as it alows youto use a defaut R functions inside map:as_mapper(is.numeric)## function (x) ## is.numeric(x = x)## &lt;environment: base&gt;or characters and numbers that creates calls to pluck:as_mapper(1)## function (x, ...) ## pluck(x, list(1), .default = NULL)## &lt;environment: 0x7fcae3543788&gt;as_mapper(&quot;this&quot;)## function (x, ...) ## pluck(x, list(&quot;this&quot;), .default = NULL)## &lt;environment: 0x7fcae3280190&gt;or even another lambda function :as_mapper(function(x, y) {x+y} )## function(x, y) {x+y}mappers with more than two argumentsSo, here’s the trick if you want to create mappers with more than twoarguments: use ..1, ..2, ..3, etc. Here’s an example with pmap.l &lt;- list(rnorm(10),          rnorm(100),           rnorm(1000))pmap_dbl(list(l, 20, TRUE), ~ mean(..1, ..2, ..3)) ## [1] 0.48879956 0.15248405 0.01861908Using mapper inside {attempt}try_catchThese are also what allows {attempt} to be flexible when buildingtrycatch calls and condition handlers.As you may know, tryCatch takes four arguments :  The expression to evaluate (mandatory)  A function to be run on error  A function to be run on warning  A function to be run on exitSo if you’ve followed along, you now know that I can use mappers here asarguments of a tryCatch call. This is exactly what try_catch, from{attempt}, does.Here’s a shorten example (and slightly different from the one in{attempt} as try_that is built with {rlang} lang) :try_catch &lt;- function(expr, .e) {  tryCatch( expr,    error = as_mapper(.e)  )}try_catch(log(&quot;a&quot;), .e = ~ paste(&quot;There was an error:&quot;, .x))## [1] &quot;There was an error: Error in log(\&quot;a\&quot;): argument non numérique pour une fonction mathématique\n&quot;stop_ifAs package developers, we need to keep in mind that everything ispossible when it comes to functions being used in the wild (charactersin place of number is just an example).So the first lines of a function are usually used to verify the inputs.Like :pimped_sum &lt;- function(x, y){  if (! is.numeric(x) | ! is.numeric(y)) {    stop(&quot;x and y must be numeric&quot;)  }  x + y}pimped_sum(&quot;1&quot;, 2)## Error in pimped_sum(&quot;1&quot;, 2): x and y must be numericBut that’s a lot of duplicated code, a lot of if if there are lot ofchecks to do, and not that much functions stating clearly what they do.So here comes {attempt}:library(attempt)## ## Attaching package: &#39;attempt&#39;## The following object is masked _by_ &#39;.GlobalEnv&#39;:## ##     try_catchpimped_sum &lt;- function(x, y){  stop_if_any( c(x, y),                ~ ! is.numeric(.x),                msg = &quot;your args should be numeric&quot;)  x + y}pimped_sum(&quot;1&quot;, 2)## Error: your args should be numericYou can have a look at what {attempt} does on the GitHubrepo.# Simpler examplesmall_by_ten &lt;- function(x){  stop_if( x,            ~ .x &gt; 10,            msg = &quot;x should be less than ten&quot; )  x * 10}small_by_ten(11)## Error: x should be less than tenSo here, you can see that we are using a formula inside stop_if. Howdoes if work ? The second argument is turned into a mapper, and thenused to test x. Here’s a simplified version of this function:stop_if &lt;- function(.x, .p){  .p &lt;- as_mapper(.p)  if ( .p(.x) )      stop(&quot;Error!&quot;)}stop_if(10, ~ .x &lt; 11)## Error in stop_if(10, ~.x &lt; 11): Error!The flexibily of the mapper system allows you to pass base and classicalfunction, because as we’ve seen, they are all turned to the samefunction template :stop_if(10, is.numeric)## Error in stop_if(10, is.numeric): Error!stop_if(10, function(x) sqrt(x) &lt; 100)## Error in stop_if(10, function(x) sqrt(x) &lt; 100): Error!Aaaaaand that’s it for today :)">



  <meta property="og:image" content="https://pbs.twimg.com/profile_banners/84618490/1545734426/1500x500">



  <meta name="twitter:site" content="@_ColinFay">
  <meta name="twitter:title" content="A Crazy Little Thing Called {purrr} - Part 4: mappers">
  <meta name="twitter:description" content="I won’t talk about the Queen reference anymore.I’ve been working lately on a new package called {attempt}, which is anattempt at making try catch and condition handling in R a little bitfriendlier. If you have some time to spare, I’ll be glad if you can giveme some feedbacks about it: positive, negative, PR, improvementsuggestions https://github.com/ColinFay/attempt… Feel free!This package relies a lot on {purrr} mappers (and on {rlang} but I won’tbe talking about {rlang} today… maybe in another series of posts). TodayI’m gonna talk briefly about this cool stuff in {purrr} called mappers.(Well, these mappers are forwarded to {rlang} so this is a cool stufffrom {rlang}, yet the mappers constructor as_mapper is a {purrr}function).What on earth are mappersYou’ve been using mappers a lot if, like me, you’ve been using {purrr} alot. These are the one sided formulas which are created as such :library(purrr)map_dbl(1:3, ~ .x * 10)## [1] 10 20 30# or map_dbl(1:3, ~ . * 10)## [1] 10 20 30# or map2_dbl(1:3, 3:5, ~ .x + .y)## [1] 4 6 8Here, you’re creating a lambda function on the fly: the first and secondmultiplying each element by 10, and the third adding each x and ytogether.What’s happening behind?The first thing that map (and other map_*) do is turning a the ~ .x\* 10 into a mapper with as_mapper.map## function(.x, .f, ...) {##   .f &lt;- as_mapper(.f, ...)##   .Call(map_impl, environment(), &quot;.x&quot;, &quot;.f&quot;, &quot;list&quot;)## }## &lt;environment: namespace:purrr&gt;In the background, mappers are created with {rlang} as_function: so,as you could have guessed, this turns formulas into functions.addition &lt;- as_mapper(~ .x + .y)addition## function (..., .x = ..1, .y = ..2, . = ..1) ## .x + .yAs you can see, the function is created with the .x matching the firstargument, the .y matching the second, and the . alone matching thefirst. It’s that simple, you now have a good old R function:addition(1,3)## [1] 4How is that useful?Don’t repeat yourselfThis first comes handy when you have a lot of mapping to do:map2_int(1:3, 4:6, addition)## [1] 5 7 9map2_int(1:10, 21:30, addition)##  [1] 22 24 26 28 30 32 34 36 38 40map2_int(2:3, 4:5, addition)## [1] 6 8Flexible mappersMappers are what allow {purrr} flexibility with mapping, as it alows youto use a defaut R functions inside map:as_mapper(is.numeric)## function (x) ## is.numeric(x = x)## &lt;environment: base&gt;or characters and numbers that creates calls to pluck:as_mapper(1)## function (x, ...) ## pluck(x, list(1), .default = NULL)## &lt;environment: 0x7fcae3543788&gt;as_mapper(&quot;this&quot;)## function (x, ...) ## pluck(x, list(&quot;this&quot;), .default = NULL)## &lt;environment: 0x7fcae3280190&gt;or even another lambda function :as_mapper(function(x, y) {x+y} )## function(x, y) {x+y}mappers with more than two argumentsSo, here’s the trick if you want to create mappers with more than twoarguments: use ..1, ..2, ..3, etc. Here’s an example with pmap.l &lt;- list(rnorm(10),          rnorm(100),           rnorm(1000))pmap_dbl(list(l, 20, TRUE), ~ mean(..1, ..2, ..3)) ## [1] 0.48879956 0.15248405 0.01861908Using mapper inside {attempt}try_catchThese are also what allows {attempt} to be flexible when buildingtrycatch calls and condition handlers.As you may know, tryCatch takes four arguments :  The expression to evaluate (mandatory)  A function to be run on error  A function to be run on warning  A function to be run on exitSo if you’ve followed along, you now know that I can use mappers here asarguments of a tryCatch call. This is exactly what try_catch, from{attempt}, does.Here’s a shorten example (and slightly different from the one in{attempt} as try_that is built with {rlang} lang) :try_catch &lt;- function(expr, .e) {  tryCatch( expr,    error = as_mapper(.e)  )}try_catch(log(&quot;a&quot;), .e = ~ paste(&quot;There was an error:&quot;, .x))## [1] &quot;There was an error: Error in log(\&quot;a\&quot;): argument non numérique pour une fonction mathématique\n&quot;stop_ifAs package developers, we need to keep in mind that everything ispossible when it comes to functions being used in the wild (charactersin place of number is just an example).So the first lines of a function are usually used to verify the inputs.Like :pimped_sum &lt;- function(x, y){  if (! is.numeric(x) | ! is.numeric(y)) {    stop(&quot;x and y must be numeric&quot;)  }  x + y}pimped_sum(&quot;1&quot;, 2)## Error in pimped_sum(&quot;1&quot;, 2): x and y must be numericBut that’s a lot of duplicated code, a lot of if if there are lot ofchecks to do, and not that much functions stating clearly what they do.So here comes {attempt}:library(attempt)## ## Attaching package: &#39;attempt&#39;## The following object is masked _by_ &#39;.GlobalEnv&#39;:## ##     try_catchpimped_sum &lt;- function(x, y){  stop_if_any( c(x, y),                ~ ! is.numeric(.x),                msg = &quot;your args should be numeric&quot;)  x + y}pimped_sum(&quot;1&quot;, 2)## Error: your args should be numericYou can have a look at what {attempt} does on the GitHubrepo.# Simpler examplesmall_by_ten &lt;- function(x){  stop_if( x,            ~ .x &gt; 10,            msg = &quot;x should be less than ten&quot; )  x * 10}small_by_ten(11)## Error: x should be less than tenSo here, you can see that we are using a formula inside stop_if. Howdoes if work ? The second argument is turned into a mapper, and thenused to test x. Here’s a simplified version of this function:stop_if &lt;- function(.x, .p){  .p &lt;- as_mapper(.p)  if ( .p(.x) )      stop(&quot;Error!&quot;)}stop_if(10, ~ .x &lt; 11)## Error in stop_if(10, ~.x &lt; 11): Error!The flexibily of the mapper system allows you to pass base and classicalfunction, because as we’ve seen, they are all turned to the samefunction template :stop_if(10, is.numeric)## Error in stop_if(10, is.numeric): Error!stop_if(10, function(x) sqrt(x) &lt; 100)## Error in stop_if(10, function(x) sqrt(x) &lt; 100): Error!Aaaaaand that’s it for today :)">
  <meta name="twitter:url" content="http://localhost:4000/purrr-mappers/">

  
    <meta name="twitter:card" content="summary">
    
      <meta name="twitter:image" content="https://pbs.twimg.com/profile_banners/84618490/1545734426/1500x500">
    
  

  



  <meta property="article:published_time" content="2017-12-12T00:00:00+01:00">





  

  


<link rel="canonical" href="http://localhost:4000/purrr-mappers/">





  <script type="application/ld+json">
    {
      "@context": "http://schema.org",
      "@type": "Organization",
      "url": "http://localhost:4000",
      "logo": "https://pbs.twimg.com/profile_banners/84618490/1545734426/1500x500"
    }
  </script>



  <script type="application/ld+json">
    {
      "@context": "http://schema.org",
      "@type": "Person",
      "name": "Colin Fay",
      "url": "http://localhost:4000",
      "sameAs": null
    }
  </script>







<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Colin Fay Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="stylesheet" href="/assets/css/concrete.css">
<link rel="stylesheet" href="/assets/css/normalize.css">
<link rel="stylesheet" href="/assets/css/github.css">

<script type="text/javascript" src=" "></script>

<!--[if lte IE 9]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->


    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="http://schema.org/Person">

  
    <div class="author__avatar">
      

      
        <img src="https://avatars1.githubusercontent.com/u/17936236?v=3&s=460" alt="Colin FAY" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Colin FAY</h3>
    
    
      <p class="author__bio" itemprop="description">
        Data Scientist & R Hacker at <a href='https://thinkr.fr/'><u>ThinkR</u></a>. Founder of <a href = 'https://data-bzh.fr'><u>Data Bzh</u></a> and cofounder of the <a href = 'http://breizhdataclub.org/'><u>Breizh Data Club</u></a>. Part of the <a href='http://www.rweekly.org'><u>RWeekly</u></a> Team.
      </p>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse"><i class = 'fas fa-bars'></i></button>
    <ul class="author__urls social-icons">
      <p><b>Navigation:</b></p>
      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->

<li>
  <a href="/">
    <i class="fa fa-arrow-right" aria-hidden="true"></i> Home
  </a>
</li>
<li>
  <a href="/categories/">
    <i class="fa fa-arrow-right" aria-hidden="true"></i> Blog
  </a>
</li>
<li>
  <a href="/about/">
    <i class="fa fa-arrow-right" aria-hidden="true"></i> About
  </a>
</li>
<li>
  <a href="/talks-publications/">
    <i class="fa fa-arrow-right" aria-hidden="true"></i> Talks & Publications
  </a>
</li>
<li>
  <a href="/open-source/">
    <i class="fa fa-arrow-right" aria-hidden="true"></i> Open Source
  </a>
</li>
<li>
  <a href="/search/">
    <i class="fa fa-arrow-right" aria-hidden="true"></i> Search
  </a>
</li>
    </ul>
  </div>
</div>

  
  </div>


  <article class="page" itemscope itemtype="http://schema.org/CreativeWork">
    <meta itemprop="headline" content="A Crazy Little Thing Called {purrr} - Part 4: mappers">
    <meta itemprop="description" content="I won’t talk about the Queen reference anymore.I’ve been working lately on a new package called {attempt}, which is anattempt at making try catch and condition handling in R a little bitfriendlier. If you have some time to spare, I’ll be glad if you can giveme some feedbacks about it: positive, negative, PR, improvementsuggestions https://github.com/ColinFay/attempt… Feel free!This package relies a lot on {purrr} mappers (and on {rlang} but I won’tbe talking about {rlang} today… maybe in another series of posts). TodayI’m gonna talk briefly about this cool stuff in {purrr} called mappers.(Well, these mappers are forwarded to {rlang} so this is a cool stufffrom {rlang}, yet the mappers constructor as_mapper is a {purrr}function).What on earth are mappersYou’ve been using mappers a lot if, like me, you’ve been using {purrr} alot. These are the one sided formulas which are created as such :library(purrr)map_dbl(1:3, ~ .x * 10)## [1] 10 20 30# or map_dbl(1:3, ~ . * 10)## [1] 10 20 30# or map2_dbl(1:3, 3:5, ~ .x + .y)## [1] 4 6 8Here, you’re creating a lambda function on the fly: the first and secondmultiplying each element by 10, and the third adding each x and ytogether.What’s happening behind?The first thing that map (and other map_*) do is turning a the ~ .x\* 10 into a mapper with as_mapper.map## function(.x, .f, ...) {##   .f &lt;- as_mapper(.f, ...)##   .Call(map_impl, environment(), &quot;.x&quot;, &quot;.f&quot;, &quot;list&quot;)## }## &lt;environment: namespace:purrr&gt;In the background, mappers are created with {rlang} as_function: so,as you could have guessed, this turns formulas into functions.addition &lt;- as_mapper(~ .x + .y)addition## function (..., .x = ..1, .y = ..2, . = ..1) ## .x + .yAs you can see, the function is created with the .x matching the firstargument, the .y matching the second, and the . alone matching thefirst. It’s that simple, you now have a good old R function:addition(1,3)## [1] 4How is that useful?Don’t repeat yourselfThis first comes handy when you have a lot of mapping to do:map2_int(1:3, 4:6, addition)## [1] 5 7 9map2_int(1:10, 21:30, addition)##  [1] 22 24 26 28 30 32 34 36 38 40map2_int(2:3, 4:5, addition)## [1] 6 8Flexible mappersMappers are what allow {purrr} flexibility with mapping, as it alows youto use a defaut R functions inside map:as_mapper(is.numeric)## function (x) ## is.numeric(x = x)## &lt;environment: base&gt;or characters and numbers that creates calls to pluck:as_mapper(1)## function (x, ...) ## pluck(x, list(1), .default = NULL)## &lt;environment: 0x7fcae3543788&gt;as_mapper(&quot;this&quot;)## function (x, ...) ## pluck(x, list(&quot;this&quot;), .default = NULL)## &lt;environment: 0x7fcae3280190&gt;or even another lambda function :as_mapper(function(x, y) {x+y} )## function(x, y) {x+y}mappers with more than two argumentsSo, here’s the trick if you want to create mappers with more than twoarguments: use ..1, ..2, ..3, etc. Here’s an example with pmap.l &lt;- list(rnorm(10),          rnorm(100),           rnorm(1000))pmap_dbl(list(l, 20, TRUE), ~ mean(..1, ..2, ..3)) ## [1] 0.48879956 0.15248405 0.01861908Using mapper inside {attempt}try_catchThese are also what allows {attempt} to be flexible when buildingtrycatch calls and condition handlers.As you may know, tryCatch takes four arguments :  The expression to evaluate (mandatory)  A function to be run on error  A function to be run on warning  A function to be run on exitSo if you’ve followed along, you now know that I can use mappers here asarguments of a tryCatch call. This is exactly what try_catch, from{attempt}, does.Here’s a shorten example (and slightly different from the one in{attempt} as try_that is built with {rlang} lang) :try_catch &lt;- function(expr, .e) {  tryCatch( expr,    error = as_mapper(.e)  )}try_catch(log(&quot;a&quot;), .e = ~ paste(&quot;There was an error:&quot;, .x))## [1] &quot;There was an error: Error in log(\&quot;a\&quot;): argument non numérique pour une fonction mathématique\n&quot;stop_ifAs package developers, we need to keep in mind that everything ispossible when it comes to functions being used in the wild (charactersin place of number is just an example).So the first lines of a function are usually used to verify the inputs.Like :pimped_sum &lt;- function(x, y){  if (! is.numeric(x) | ! is.numeric(y)) {    stop(&quot;x and y must be numeric&quot;)  }  x + y}pimped_sum(&quot;1&quot;, 2)## Error in pimped_sum(&quot;1&quot;, 2): x and y must be numericBut that’s a lot of duplicated code, a lot of if if there are lot ofchecks to do, and not that much functions stating clearly what they do.So here comes {attempt}:library(attempt)## ## Attaching package: &#39;attempt&#39;## The following object is masked _by_ &#39;.GlobalEnv&#39;:## ##     try_catchpimped_sum &lt;- function(x, y){  stop_if_any( c(x, y),                ~ ! is.numeric(.x),                msg = &quot;your args should be numeric&quot;)  x + y}pimped_sum(&quot;1&quot;, 2)## Error: your args should be numericYou can have a look at what {attempt} does on the GitHubrepo.# Simpler examplesmall_by_ten &lt;- function(x){  stop_if( x,            ~ .x &gt; 10,            msg = &quot;x should be less than ten&quot; )  x * 10}small_by_ten(11)## Error: x should be less than tenSo here, you can see that we are using a formula inside stop_if. Howdoes if work ? The second argument is turned into a mapper, and thenused to test x. Here’s a simplified version of this function:stop_if &lt;- function(.x, .p){  .p &lt;- as_mapper(.p)  if ( .p(.x) )      stop(&quot;Error!&quot;)}stop_if(10, ~ .x &lt; 11)## Error in stop_if(10, ~.x &lt; 11): Error!The flexibily of the mapper system allows you to pass base and classicalfunction, because as we’ve seen, they are all turned to the samefunction template :stop_if(10, is.numeric)## Error in stop_if(10, is.numeric): Error!stop_if(10, function(x) sqrt(x) &lt; 100)## Error in stop_if(10, function(x) sqrt(x) &lt; 100): Error!Aaaaaand that’s it for today :)">
    <meta itemprop="datePublished" content="December 12, 2017">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">A Crazy Little Thing Called {purrr} - Part 4: mappers
</h1>
          
            <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  5 minute(s) read
</p>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
        <p>I won’t talk about the Queen reference anymore.</p>

<p>I’ve been working lately on a new package called {attempt}, which is an
attempt at making try catch and condition handling in R a little bit
friendlier. If you have some time to spare, I’ll be glad if you can give
me some feedbacks about it: positive, negative, PR, improvement
suggestions <a href="https://github.com/ColinFay/attempt">https://github.com/ColinFay/attempt</a>… Feel free!</p>

<p>This package relies a lot on {purrr} mappers (and on {rlang} but I won’t
be talking about {rlang} today… maybe in another series of posts). Today
I’m gonna talk briefly about this cool stuff in {purrr} called mappers.
(Well, these mappers are forwarded to {rlang} so this is a cool stuff
from {rlang}, yet the mappers constructor <code class="highlighter-rouge">as_mapper</code> is a {purrr}
function).</p>

<h2 id="what-on-earth-are-mappers">What on earth are mappers</h2>

<p>You’ve been using mappers a lot if, like me, you’ve been using {purrr} a
lot. These are the one sided formulas which are created as such :</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">library</span><span class="p">(</span><span class="n">purrr</span><span class="p">)</span><span class="w">
</span><span class="n">map_dbl</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="m">3</span><span class="p">,</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">.x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">10</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## [1] 10 20 30
</code></pre></div></div>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># or </span><span class="w">
</span><span class="n">map_dbl</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="m">3</span><span class="p">,</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">.</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">10</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## [1] 10 20 30
</code></pre></div></div>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># or </span><span class="w">
</span><span class="n">map2_dbl</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="m">3</span><span class="p">,</span><span class="w"> </span><span class="m">3</span><span class="o">:</span><span class="m">5</span><span class="p">,</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">.x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">.y</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## [1] 4 6 8
</code></pre></div></div>

<p>Here, you’re creating a lambda function on the fly: the first and second
multiplying each element by 10, and the third adding each <code class="highlighter-rouge">x</code> and <code class="highlighter-rouge">y</code>
together.</p>

<h2 id="whats-happening-behind">What’s happening behind?</h2>

<p>The first thing that <code class="highlighter-rouge">map</code> (and other map_*) do is turning a the <code class="highlighter-rouge">~ .x
\* 10</code> into a mapper with <code class="highlighter-rouge">as_mapper</code>.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">map</span><span class="w">
</span></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## function(.x, .f, ...) {
##   .f &lt;- as_mapper(.f, ...)
##   .Call(map_impl, environment(), ".x", ".f", "list")
## }
## &lt;environment: namespace:purrr&gt;
</code></pre></div></div>

<p>In the background, mappers are created with {rlang} <code class="highlighter-rouge">as_function</code>: so,
as you could have guessed, this turns formulas into functions.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">addition</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">as_mapper</span><span class="p">(</span><span class="o">~</span><span class="w"> </span><span class="n">.x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">.y</span><span class="p">)</span><span class="w">
</span><span class="n">addition</span><span class="w">
</span></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## function (..., .x = ..1, .y = ..2, . = ..1) 
## .x + .y
</code></pre></div></div>

<p>As you can see, the function is created with the .x matching the first
argument, the .y matching the second, and the . alone matching the
first. It’s that simple, you now have a good old R function:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">addition</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="m">3</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## [1] 4
</code></pre></div></div>

<h2 id="how-is-that-useful">How is that useful?</h2>

<h3 id="dont-repeat-yourself">Don’t repeat yourself</h3>

<p>This first comes handy when you have a lot of mapping to do:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">map2_int</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="m">3</span><span class="p">,</span><span class="w"> </span><span class="m">4</span><span class="o">:</span><span class="m">6</span><span class="p">,</span><span class="w"> </span><span class="n">addition</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## [1] 5 7 9
</code></pre></div></div>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">map2_int</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="m">10</span><span class="p">,</span><span class="w"> </span><span class="m">21</span><span class="o">:</span><span class="m">30</span><span class="p">,</span><span class="w"> </span><span class="n">addition</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>##  [1] 22 24 26 28 30 32 34 36 38 40
</code></pre></div></div>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">map2_int</span><span class="p">(</span><span class="m">2</span><span class="o">:</span><span class="m">3</span><span class="p">,</span><span class="w"> </span><span class="m">4</span><span class="o">:</span><span class="m">5</span><span class="p">,</span><span class="w"> </span><span class="n">addition</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## [1] 6 8
</code></pre></div></div>

<h3 id="flexible-mappers">Flexible mappers</h3>

<p>Mappers are what allow {purrr} flexibility with mapping, as it alows you
to use a defaut R functions inside map:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">as_mapper</span><span class="p">(</span><span class="n">is.numeric</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## function (x) 
## is.numeric(x = x)
## &lt;environment: base&gt;
</code></pre></div></div>

<p>or characters and numbers that creates calls to <code class="highlighter-rouge">pluck</code>:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">as_mapper</span><span class="p">(</span><span class="m">1</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## function (x, ...) 
## pluck(x, list(1), .default = NULL)
## &lt;environment: 0x7fcae3543788&gt;
</code></pre></div></div>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">as_mapper</span><span class="p">(</span><span class="s2">"this"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## function (x, ...) 
## pluck(x, list("this"), .default = NULL)
## &lt;environment: 0x7fcae3280190&gt;
</code></pre></div></div>

<p>or even another lambda function :</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">as_mapper</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="n">x</span><span class="o">+</span><span class="n">y</span><span class="p">}</span><span class="w"> </span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## function(x, y) {x+y}
</code></pre></div></div>

<h3 id="mappers-with-more-than-two-arguments">mappers with more than two arguments</h3>

<p>So, here’s the trick if you want to create mappers with more than two
arguments: use <code class="highlighter-rouge">..1</code>, <code class="highlighter-rouge">..2</code>, <code class="highlighter-rouge">..3</code>, etc. Here’s an example with <code class="highlighter-rouge">pmap</code>.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">l</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="n">rnorm</span><span class="p">(</span><span class="m">10</span><span class="p">),</span><span class="w">
          </span><span class="n">rnorm</span><span class="p">(</span><span class="m">100</span><span class="p">),</span><span class="w"> 
          </span><span class="n">rnorm</span><span class="p">(</span><span class="m">1000</span><span class="p">))</span><span class="w">
</span><span class="n">pmap_dbl</span><span class="p">(</span><span class="nf">list</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="m">20</span><span class="p">,</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">),</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">mean</span><span class="p">(</span><span class="n">.</span><span class="m">.1</span><span class="p">,</span><span class="w"> </span><span class="n">.</span><span class="m">.2</span><span class="p">,</span><span class="w"> </span><span class="n">.</span><span class="m">.3</span><span class="p">))</span><span class="w"> 
</span></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## [1] 0.48879956 0.15248405 0.01861908
</code></pre></div></div>

<h2 id="using-mapper-inside-attempt">Using mapper inside {attempt}</h2>

<h3 id="try_catch">try_catch</h3>

<p>These are also what allows {attempt} to be flexible when building
trycatch calls and condition handlers.</p>

<p>As you may know, <code class="highlighter-rouge">tryCatch</code> takes four arguments :</p>

<ul>
  <li>The expression to evaluate (mandatory)</li>
  <li>A <strong>function</strong> to be run on error</li>
  <li>A <strong>function</strong> to be run on warning</li>
  <li>A <strong>function</strong> to be run on exit</li>
</ul>

<p>So if you’ve followed along, you now know that I can use mappers here as
arguments of a <code class="highlighter-rouge">tryCatch</code> call. This is exactly what <code class="highlighter-rouge">try_catch</code>, from
{attempt}, does.</p>

<p>Here’s a shorten example (and slightly different from the one in
{attempt} as <code class="highlighter-rouge">try_that</code> is built with {rlang} <code class="highlighter-rouge">lang</code>) :</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">try_catch</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span><span class="w"> </span><span class="n">.e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="n">tryCatch</span><span class="p">(</span><span class="w"> </span><span class="n">expr</span><span class="p">,</span><span class="w">
    </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">as_mapper</span><span class="p">(</span><span class="n">.e</span><span class="p">)</span><span class="w">
  </span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="n">try_catch</span><span class="p">(</span><span class="nf">log</span><span class="p">(</span><span class="s2">"a"</span><span class="p">),</span><span class="w"> </span><span class="n">.e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">paste</span><span class="p">(</span><span class="s2">"There was an error:"</span><span class="p">,</span><span class="w"> </span><span class="n">.x</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## [1] "There was an error: Error in log(\"a\"): argument non numérique pour une fonction mathématique\n"
</code></pre></div></div>

<h3 id="stop_if">stop_if</h3>

<p>As package developers, we need to keep in mind that everything is
possible when it comes to functions being used in the wild (characters
in place of number is just an example).</p>

<p>So the first lines of a function are usually used to verify the inputs.
Like :</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pimped_sum</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">){</span><span class="w">
  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="w"> </span><span class="nf">is.numeric</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="nf">is.numeric</span><span class="p">(</span><span class="n">y</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">stop</span><span class="p">(</span><span class="s2">"x and y must be numeric"</span><span class="p">)</span><span class="w">
  </span><span class="p">}</span><span class="w">
  </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="n">pimped_sum</span><span class="p">(</span><span class="s2">"1"</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## Error in pimped_sum("1", 2): x and y must be numeric
</code></pre></div></div>

<p>But that’s a lot of duplicated code, a lot of if if there are lot of
checks to do, and not that much functions stating clearly what they do.</p>

<p>So here comes {attempt}:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">library</span><span class="p">(</span><span class="n">attempt</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## 
## Attaching package: 'attempt'

## The following object is masked _by_ '.GlobalEnv':
## 
##     try_catch
</code></pre></div></div>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pimped_sum</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">){</span><span class="w">
  </span><span class="n">stop_if_any</span><span class="p">(</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">),</span><span class="w"> 
               </span><span class="o">~</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="nf">is.numeric</span><span class="p">(</span><span class="n">.x</span><span class="p">),</span><span class="w"> 
               </span><span class="n">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"your args should be numeric"</span><span class="p">)</span><span class="w">
  </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="n">pimped_sum</span><span class="p">(</span><span class="s2">"1"</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## Error: your args should be numeric
</code></pre></div></div>

<p>You can have a look at what {attempt} does on the <a href="https://github.com/ColinFay/attempt">GitHub
repo</a>.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Simpler example</span><span class="w">
</span><span class="n">small_by_ten</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">x</span><span class="p">){</span><span class="w">
  </span><span class="n">stop_if</span><span class="p">(</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> 
           </span><span class="o">~</span><span class="w"> </span><span class="n">.x</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">10</span><span class="p">,</span><span class="w"> 
           </span><span class="n">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"x should be less than ten"</span><span class="w"> </span><span class="p">)</span><span class="w">
  </span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">10</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="n">small_by_ten</span><span class="p">(</span><span class="m">11</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## Error: x should be less than ten
</code></pre></div></div>

<p>So here, you can see that we are using a formula inside <code class="highlighter-rouge">stop_if</code>. How
does if work ? The second argument is turned into a mapper, and then
used to test x. Here’s a simplified version of this function:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">stop_if</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">.x</span><span class="p">,</span><span class="w"> </span><span class="n">.p</span><span class="p">){</span><span class="w">
  </span><span class="n">.p</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">as_mapper</span><span class="p">(</span><span class="n">.p</span><span class="p">)</span><span class="w">
  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">.p</span><span class="p">(</span><span class="n">.x</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w">
      </span><span class="n">stop</span><span class="p">(</span><span class="s2">"Error!"</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="n">stop_if</span><span class="p">(</span><span class="m">10</span><span class="p">,</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">.x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">11</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## Error in stop_if(10, ~.x &lt; 11): Error!
</code></pre></div></div>

<p>The flexibily of the mapper system allows you to pass base and classical
function, because as we’ve seen, they are all turned to the same
function template :</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">stop_if</span><span class="p">(</span><span class="m">10</span><span class="p">,</span><span class="w"> </span><span class="n">is.numeric</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## Error in stop_if(10, is.numeric): Error!
</code></pre></div></div>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">stop_if</span><span class="p">(</span><span class="m">10</span><span class="p">,</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="nf">sqrt</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">100</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## Error in stop_if(10, function(x) sqrt(x) &lt; 100): Error!
</code></pre></div></div>

<p>Aaaaaand that’s it for today :)</p>


        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/tags/#purrr" class="page__taxonomy-item" rel="tag">purrr</a>
    
    </span>
  </p>




  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/categories/#r-blog-en" class="page__taxonomy-item" rel="tag">r-blog-en</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2017-12-12T00:00:00+01:00">December 12, 2017</time></p>
        
      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">Share on</h4>
  

  <a href="https://twitter.com/intent/tweet?via=_ColinFay&text=A+Crazy+Little+Thing+Called+%7Bpurrr%7D+-+Part+4%3A+mappers%20http%3A%2F%2Flocalhost%3A4000%2Fpurrr-mappers%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Flocalhost%3A4000%2Fpurrr-mappers%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://plus.google.com/share?url=http%3A%2F%2Flocalhost%3A4000%2Fpurrr-mappers%2F" class="btn btn--google-plus" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Google Plus"><i class="fab fa-fw fa-google-plus" aria-hidden="true"></i><span> Google+</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Flocalhost%3A4000%2Fpurrr-mappers%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/purrr-set-na/" class="pagination--pager" title="A Crazy Little Thing Called {purrr} - Part 3 : Setting NA
">←</a>
    
    
      <a href="/purrr-code-optim/" class="pagination--pager" title="A Crazy Little Thing Called {purrr} - Part 5: code optimization
">→</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">The machine thinks you might also like:</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
    <li class="archive__item-title" itemprop="headline">
      <span>
        
        <a href="/js-const-r/" rel="permalink">JavaScript const in R
</a>
      
      </span>
      <span class="page__meta" >
        
      —  <i>2019-09-23</i>
    
      </span>
    </li>
    
    <!--<p class="archive__item-excerpt" itemprop="description">One thing I like about JavaScript is the const declaration method,
which allows you to declare a variable one time, and that variable can’t
be reassigned aft...</p>-->
  </article>
</div>
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
    <li class="archive__item-title" itemprop="headline">
      <span>
        
        <a href="/one-week-shiny-google-search/" rel="permalink">One week as a Shiny dev, seen through Google search
</a>
      
      </span>
      <span class="page__meta" >
        
      —  <i>2019-09-08</i>
    
      </span>
    </li>
    
    <!--<p class="archive__item-excerpt" itemprop="description">Some days ago I read an article on dev.to, entitled
something like “Googling as a Software Engineer”
link
which links to this
blogpost
from Sophie Koonin. An...</p>-->
  </article>
</div>
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
    <li class="archive__item-title" itemprop="headline">
      <span>
        
        <a href="/playing-with-dolt-one/" rel="permalink">Playing with dolt - Part One
</a>
      
      </span>
      <span class="page__meta" >
        
      —  <i>2019-08-17</i>
    
      </span>
    </li>
    
    <!--<p class="archive__item-excerpt" itemprop="description">A few weeks back, I subscribed to become a beta tester for dolt, the
“Git for data”. This post is the first of a series of posts
exploring this tool.

What i...</p>-->
  </article>
</div>
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
    <li class="archive__item-title" itemprop="headline">
      <span>
        
        <a href="/back-from-toulouse/" rel="permalink">Back from useR! 2019
</a>
      
      </span>
      <span class="page__meta" >
        
      —  <i>2019-07-14</i>
    
      </span>
    </li>
    
    <!--<p class="archive__item-excerpt" itemprop="description">I’m back from useR! 2019!, Toulouse, where I gave one talk and a
workshop. Here are the links to the materials.

2019-07-08

Contributing to the R ecosystem
...</p>-->
  </article>
</div>
        
      </div>
    </div>
  
</div>
    </div>

    

    <div class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Get social:</strong></li>
    
    
      <li><a href="https://twitter.com/_ColinFay"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
    
    
    
      <li><a href="https://github.com/ColinFay"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
    
    
    
    
      <li><a href="https://www.linkedin.com/in/colinfay"><i class="fab fa-fw fa-linkedin-in" aria-hidden="true"></i> LinkedIn</a></li>
    
     
        <li>
          <a href="mailto:">
            <meta itemprop="email" content="" />
            <i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i> Email
          </a>
        </li>
      
    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2019 Colin Fay. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a>, built on top of the <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a> jekyll theme. </div>

<div class="page__footer-copyright">All blog posts are aggregated to <a href = "https://www.r-bloggers.com/">R-bloggers</a> and <a href="http://www.rweekly.org">RWeekly</a>.</div>

<div class="page__footer-copyright">All written content on this blog is released under the <a href = "https://creativecommons.org/licenses/by-nc-sa/4.0//">CC BY-NC-SA 4.0</a> license, with the exception of code which is released under the <a href="https://opensource.org/licenses/mit-license.php">MIT</a> license</div>.

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/all.css" integrity="sha384-oS3vJWv+0UjzBfQzYUhtDYW+Pj2yciDJxpsK1OYPAYjqT085Qq/1cq5FLXAZQ7Ay" crossorigin="anonymous">







    
  <script>
    var disqus_config = function () {
      this.page.url = "http://localhost:4000/purrr-mappers/";  // Replace PAGE_URL with your page's canonical URL variable
      this.page.identifier = "/purrr-mappers"; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    (function() { // DON'T EDIT BELOW THIS LINE
      var d = document, s = d.createElement('script');
      s.src = 'https://http-colinfay-me.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


  



  </body>
</html>